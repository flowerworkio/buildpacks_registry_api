#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "$0")/.."
source bin/functions.sh

describe ":elixir: :git: clean up everything :broom:"
mix clean
mix deps.clean --all
git fetch --prune --prune-tags --tags origin

describe ":elixir: getting dependencies"
mix deps.get

export MIX_ENV=prod

describe ":elixir: compiling package"
mix compile

version="v$(mix run -e "IO.puts BuildpacksRegistryApi.MixProject.version")"
describe "Creating git tag $version"
git tag $version
git push origin --tags

describe "Publishing the package to :flowerwork: organization on hex.pm"
mix hex.publish --yes
